---
title: "Inferential Analyses"
output: 
  html_document:
    code_folding: hide
---

```{r setup}
library(tidyverse)
library(janitor)
library(broom)
library(knitr)
library(purrr)

data <- read_csv("data/cleaned_drug_data.csv")

traits <- c("Nscore","Escore","Oscore","Ascore","Cscore")

make_status <- function(x) ifelse(x>0,"User","Non-User")
```

# 1. Define Drug Groups

```{r}
data <- data %>%
  mutate(
    stim_group = Coke + Meth, #stimulants
    highrisk = Heroin + Crack + VSA, #highly potent & fatal
    psych = LSD + Mushrooms + Ketamine + Ecstasy + Legalh #psychedelics
  )
```

# 2. Function for Chi-square, ANOVA, Correlations

```{r}
#helper functions
chi_wrapper <- function(var){
  tab <- table(data[[var]], data$Education)
  chi1 <- chisq.test(table(data[[var]]>0, data$Education))
  chi2 <- chisq.test(table(data[[var]]>0, data$Country))
  list(edu = chi1, country = chi2)
}

anova_wrapper <- function(var){
  data %>% mutate(status = make_status(.data[[var]])) -> d
  map_df(traits, function(tr){
    model <- aov(as.formula(paste0(tr," ~ status")), data=d)
    tidy(model) %>% filter(term=="status") %>% mutate(trait=tr)
  })
}

corr_wrapper <- function(var){
  map_df(traits, function(tr){
    ct <- cor.test(data[[tr]], data[[var]], method="pearson")
    tibble(trait=tr, correlation=ct$estimate, p=ct$p.value)
  })
}
```


# 3. Run Analyses for Selected Drugs

## 3.1 Cannabis
```{r}
chi_can <- chi_wrapper("Cannabis")
chi_can$edu
chi_can$country

anova_can <- anova_wrapper("Cannabis")
kable(anova_can, caption="ANOVA — Cannabis")

corr_can <- corr_wrapper("Cannabis")
kable(corr_can, caption="Correlations — Cannabis")
```

## 3.2 Nicotine
```{r}
chi_nic <- chi_wrapper("Nicotine")
chi_nic$edu
chi_nic$country

anova_nic <- anova_wrapper("Nicotine")
kable(anova_nic, caption="ANOVA — Nicotine")

corr_nic <- corr_wrapper("Nicotine")
kable(corr_nic, caption="Correlations — Nicotine")

```


## 3.3 Amphetamines
```{r}
chi_amp <- chi_wrapper("Amphet")
chi_amp$edu
chi_amp$country

anova_amp <- anova_wrapper("Amphet")
kable(anova_amp, caption="ANOVA — Amphetamines")

corr_amp <- corr_wrapper("Amphet")
kable(corr_amp, caption="Correlations — Amphetamines")
```

## 3.4 Benzodiazepines
```{r}
chi_ben <- chi_wrapper("Benzos")
chi_ben$edu
chi_ben$country

anova_ben <- anova_wrapper("Benzos")
kable(anova_ben, caption="ANOVA — Benzodiazepines")

corr_ben <- corr_wrapper("Benzos")
kable(corr_ben, caption="Correlations — Benzodiazepines")
```

## 3.5 Stimulants (Cocaine + Methamphetamine)
```{r}
chi_stim <- chi_wrapper("stim_group")
chi_stim$edu
chi_stim$country

anova_stim <- anova_wrapper("stim_group")
kable(anova_stim, caption="ANOVA — Stimulants")

corr_stim <- corr_wrapper("stim_group")
kable(corr_stim, caption="Correlations — Stimulants")
```

## 3.6 High Risk (Heroin + Crack + VSA)
```{r}
chi_hr <- chi_wrapper("highrisk")
chi_hr$edu
chi_hr$country

anova_hr <- anova_wrapper("highrisk")
kable(anova_hr, caption="ANOVA — High Risk Drugs")

corr_hr <- corr_wrapper("highrisk")
kable(corr_hr, caption="Correlations — High Risk Drugs")
```

## 3.7 Psychedelics (LSD + Mushrooms + Ketamine + Ecstasy + Legal-H)
```{r}
chi_psy <- chi_wrapper("psych")
chi_psy$edu
chi_psy$country

anova_psy <- anova_wrapper("psych")
kable(anova_psy, caption="ANOVA — Psychedelics")

corr_psy <- corr_wrapper("psych")
kable(corr_psy, caption="Correlations — Psychedelics")
```



